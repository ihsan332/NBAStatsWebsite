{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{player.fname}} {{player.lname}}</title>
    <link rel="stylesheet" href="{% static 'catalog/display.css'%}">
</head>
<body>
<h1 id="table-header">{{player.fname}} {{player.lname}}</h1>   

{% if userRole == 'admin' %}
<button onclick="deletePlayer()" style="background: red; color: white;">Delete Player</button>
<button onclick="editHeadshot()" style="background: rgb(203, 230, 197); color: rgb(0, 0, 0);">Edit Headshot</button>
{% endif %}
<img id="headshot" src="{{headshot.headshot}}">


<canvas id="ShotDistribution"></canvas>
<canvas id="StatDistribution"></canvas>
<canvas id="ShotEfficiency"></canvas>
<canvas id="GameAverages"></canvas>
<canvas id="OffenseDefense"></canvas>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

const ppg = {{season.games}} > 0 ? {{season.points}} / {{season.games}} : 0;
const rpg = {{season.rebounds}} / {{season.games}};
const apg = {{season.assists}} / {{season.games}};
const spg = {{season.steals}} / {{season.games}};
const bpg = {{season.blocks}} / {{season.games}};

const offensescore = {{season.fieldgoals}} + {{season.assists}};
const defensescore = {{season.steals}} + {{season.blocks}} + {{season.rebounds}} + {{season.freegoals}};

new Chart(document.getElementById('ShotDistribution'), {
    type: 'bar',
    data: {
        labels: ['Two Pointers', 'Three Pointers', 'Free Throws'],

        datasets: [{label: 'Shots Made', data: [{{season.twogoals}}, {{season.threegoals}}, {{season.freegoals}}]}]
    },
    options: {
        plugins: {
            title: {
                display: true,
                text: 'Shooting Distribution'}}}  
});


new Chart(document.getElementById('StatDistribution'), {
    type: 'bar',
    data: {
        labels: ['Points', 'Rebounds', 'Assists', 'Steals', 'Blocks'],

        datasets: [{label: 'Count', data: [{{season.points}}, {{season.rebounds}}, {{season.assists}}, {{season.steals}}, {{season.blocks}}]}]
    },
    options: {
        plugins: {
            title: {
                display: true,
                text: 'Season Totals'}},
                font: {
                    size: 26
                },
        scales: {
            y: {type: 'logarithmic'}}}  
});


new Chart(document.getElementById('ShotEfficiency'), {
    type: 'radar',
    data: {
        labels: ['2P%', '3P%', 'FT%'],

        datasets: [{label: 'Percent', data: [{{season.twopercent}}, {{season.threepercent}}, {{season.freepercent}}]}]
    },
    options: {
        plugins: {
            title: {
                display: true,
                text: 'Shooting Efficiency (%)'}},
        scales: {
            r: {beginAtZero: true, min: 0, max: 100}}}  
});


new Chart(document.getElementById('GameAverages'), {
    type: 'bar',
    data: {
        labels: ['Points', 'Rebounds', 'Assists', 'Steals', 'Blocks'],

        datasets: [{label: 'Average Per Game', data: [ppg, rpg, apg, spg, bpg]}]
    },
    options: {
        plugins: {
            title: {
                display: true,
                text: 'Game Averages'}}}  
});


new Chart(document.getElementById('OffenseDefense'), {
    type: 'bar',
    data: {
        labels: ['Offense Score', 'Defense Score'],

        datasets: [{label: 'Score', data: [offensescore, defensescore]}]
    },
    options: {
        plugins: {
            title: {
                display: true,
                text: 'Offense vs Defense Score'}}}  
});


function deletePlayer() {
    if (confirm('Are you sure you want to delete this player?')) {
        const playerId = {{ player.player_id }};
        
        fetch(`delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'deleted') {
                alert('Player deleted!');
                window.location.href = '/';  
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function editHeadshot() {
    const newHeadshotUrl = prompt('Enter new headshot URL:');
    if (newHeadshotUrl) {
        const playerId = {{ player.player_id }};
        
        fetch(`update_headshot/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ headshot: newHeadshotUrl }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'updated') {
                alert('Headshot updated!');
                document.getElementById('headshot').src = newHeadshotUrl;
            }
        });
    }
}
</script>
</body>
</html>